# Data Structure Required for `plot_throughput_and_training.py`

## Directory Structure

The script expects the following directory structure:

```
experiment_directory/
├── average_metrics.csv                    # Required: ML training metrics
├── average_elapsed_time_all_iterations.csv  # Optional: Time mapping (if metrics don't have time_elapsed column)
└── <experiment_name>_keydb/              # Required: Directory ending with "_keydb"
    └── <experiment_name>/                 # Subdirectory (name can match experiment)
        ├── <server1>_breakdown.csv        # Required: Throughput breakdown per server
        ├── <server2>_breakdown.csv
        └── <server3>_breakdown.csv
```

**Example:**
```
ember_mlp_sync/
├── average_metrics.csv
├── average_elapsed_time_all_iterations.csv
└── ember_mlp_sync_keydb/
    └── ember_mlp_sync/
        ├── mteverest1_breakdown.csv
        ├── mteverest3_breakdown.csv
        └── mteverest4_breakdown.csv
```

## File Formats

### 1. `*_breakdown.csv` Files

**Location:** `<experiment_name>_keydb/<experiment_name>/*_breakdown.csv`

**Required Columns:**
- `experiment` - Experiment name/identifier
- `server` - Server name (e.g., "mteverest1", "mteverest3")
- `second` - Unix timestamp (seconds)
- `elapsed_seconds` - Elapsed time from start (numeric)
- `client` - Commands per second from direct clients
- `<master_ip1>`, `<master_ip2>`, ... - Commands per second from each master (dynamic columns)
- `total` - Total commands per second

**Example:**
```csv
experiment,server,second,elapsed_seconds,client,10.22.12.93,10.22.13.174,10.22.14.63,unknown_master,total
keydb_logs,mteverest1,1762469217,1444,10,8,0,0,0,18
keydb_logs,mteverest1,1762468926,1153,0,0,0,10,0,10
```

**Note:** These files are generated by `separate_log_analyzer.sh` script.

### 2. `average_metrics.csv` File

**Location:** `<experiment_directory>/average_metrics.csv`

**Required Columns (at least one of the following):**

**Option A: With elapsed time directly:**
- `iteration` - Training iteration number
- `time_elapsed` - OR `elapsed_seconds` - OR `elapsed_time` - OR `seconds` (one of these)
- `avg_train_acc` - Average training accuracy (optional)
- `avg_val_acc` - Average validation accuracy (optional)
- `avg_test_acc` - Average test accuracy (optional)
- `avg_train_loss` - Average training loss (optional)
- `avg_val_loss` - Average validation loss (optional)
- `avg_test_loss` - Average test loss (optional)

**Option B: Without elapsed time (requires mapping file):**
- `iteration` - Training iteration number
- `avg_train_acc`, `avg_val_acc`, `avg_test_acc` - Accuracy metrics (optional)
- `avg_train_loss`, `avg_val_loss`, `avg_test_loss` - Loss metrics (optional)

**Example (with time_elapsed):**
```csv
iteration,time_elapsed,avg_train_acc,avg_val_acc,avg_train_loss,avg_val_loss
0,0.0,0.5234,0.5123,0.8234,0.8456
1,2.5,0.5345,0.5234,0.8123,0.8345
2,5.1,0.5456,0.5345,0.8012,0.8234
```

**Note:** This file is typically generated by `plot.py` script from training logs.

### 3. `average_elapsed_time_all_iterations.csv` File (Optional)

**Location:** `<experiment_directory>/average_elapsed_time_all_iterations.csv`

**Required Columns:**
- `iteration` - Training iteration number
- `avg_time_elapsed` - OR `time_elapsed` - OR `elapsed_seconds` - OR `average_elapsed_seconds` - OR `elapsed_time` - OR `elapsed` - OR `seconds` - OR `time_s` (one of these)

**Example:**
```csv
iteration,avg_time_elapsed
0,0.0
1,2.5
2,5.1
3,7.8
```

**When needed:** Only required if `average_metrics.csv` doesn't have a direct elapsed time column. This file maps iterations to elapsed time.

**Note:** This file is also generated by `plot.py` script.

## How the Script Works

1. **Throughput Data:**
   - Searches for directories ending with `_keydb` in the experiment directory
   - Looks for `*_breakdown.csv` files in `<experiment_name>_keydb/<experiment_name>/`
   - Plots all source columns (client, master IPs, total) vs `elapsed_seconds`

2. **ML Metrics Data:**
   - Looks for `average_metrics.csv` in the experiment directory
   - If metrics have `time_elapsed` (or similar) column → uses it directly
   - If metrics only have `iteration` → looks for `average_elapsed_time_all_iterations.csv` to map iterations to time
   - Plots accuracy (left y-axis) and loss (right y-axis) vs elapsed time

## Current Structure Issue

**Your current structure:**
```
ember_mlp_sync/
└── keydb_logs/
    ├── mteverest1_breakdown.csv
    ├── mteverest3_breakdown.csv
    └── mteverest4_breakdown.csv
```

**Expected structure:**
```
ember_mlp_sync/
└── ember_mlp_sync_keydb/        # Directory must end with "_keydb"
    └── ember_mlp_sync/           # Subdirectory (can be any name)
        ├── mteverest1_breakdown.csv
        ├── mteverest3_breakdown.csv
        └── mteverest4_breakdown.csv
```

## Solution

You have two options:

1. **Rename/move directories** to match expected structure
2. **Modify the script** to look for `keydb_logs/` instead of `*_keydb/`

The script currently searches for:
```python
glob.glob(os.path.join(keydb_root, '*', '*_breakdown.csv'))
```

Which expects: `<experiment>_keydb/<subdir>/*_breakdown.csv`

But your files are at: `keydb_logs/*_breakdown.csv`





